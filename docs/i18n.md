# Internationalization (i18n)

See [online wiki](https://github.com/openwrt/luci/wiki/i18n) for latest version.

## Use translation function

### Translations in JavaScript

Wrap translatable strings with `_()` e.g.  `_('string to translate')` and the `i18n-scan.pl` and friends will correctly identify these strings for translation.

If you have multi line strings you can split them with concatenation:
```js
var mystr = _('this string will translate ' +
	'correctly even though it is ' +
	'a multi line string!');
```

You may also use line continuations `\` syntax:

```js
var mystr = _('this string will translate \
	correctly even though it is \
	a multi line string');
```

Usually if you have multiple sentences you may need to use a line break. Use the `<br />` HTML tag like so:
```js
var mystr = _('Port number.') + '<br />' +
	_('E.g. 80 for HTTP');
```
Use `<br />` and **not** `<br>` or `<br/>`.

If you have a link inside a translation, move its attributes out of a translation key:
```js
var mystr = _('For further information <a %s>check the wiki</a>')
	.format('href="https://openwrt.org/docs/" target="_blank" rel="noreferrer"')
```
This will generate a full link with HTML `For further information <a href="https://openwrt.org/docs/" target="_blank" rel="noreferrer">check the wiki</a>`. The `noreferrer` is important so that it is opened in a new tab (`target="_blank"`).

### Translations in LuCI lua+html templates
Use the `<%: text to translate %>` as documented on [Templates](./Templates.md)

### Translations in Lua controller code and Lua CBIs
As hinted at in the Templates doc, the `%:` invokes a `translate()` function.
In most controller contexts, this is already available for you, but if necessary, is available for include in `luci.i18n.translate`


## Kick-start i18n for your new app

*Note*: The GNU `gettext` utilities (`msgcat`, `msgfmt`, `msgmerge`) are required.
Debian/Ubuntu: `sudo apt install gettext`. macOS: `brew install gettext`


You've finished making your app:

```
applications/luci-app-fxx
├── Makefile
├── htdocs
│   └── luci-static
│       └── resources
│           └── view
│               └── fxx
│                   ├── form.js
│                   ├── htmlview.js
│                   ├── rpc-jsonmap-tablesection.js
│                   ├── rpc-jsonmap-typedsection.js
│                   └── rpc.js
└── root
    ├── etc
    │   └── uci-defaults
    │       └── 80_example
    └── usr
        ├── libexec
        │   └── rpcd
        │       └── luci.fxx
        └── share
            ├── luci
            │   └── menu.d
            │       └── luci-app-fxx.json
            └── rpcd
                └── acl.d
                    └── luci-app-fxx.json
```

Run
```
build/i18n-init.sh applications/luci-app-fxx
```

And you should now also have a po folder with a templates subfolder, and accompanying language folders:

```
applications/luci-app-fxx
├── Makefile
├── htdocs
...
├── po
│   ├── ar
│   │   └── fxx.po
│   ├── bg
│   │   └── fxx.po
│   ├── bn_BD
│   │   └── fxx.po
...
│   ├── templates
│   │   └── fxx.pot
...
```

The init scripts runs `git add <po-file>`.


### Update i18n po files
After you make changes to any package, including those already committed to the main branch (which may contain translations), run:

	./build/i18n-sync.sh applications/[application]

Example:

	./build/i18n-sync.sh applications/luci-app-acl

This updates i18n .po files in `applications/luci-app-acl/po/`.

*Note*: the directory argument can be omitted to update all po template and po files in the repo.

Include these changed files in an additional commit.


### Rebuild base i18n po files

If you make changes in any of the following folders
```
modules/luci-base
modules/luci-compat
modules/luci-lua-runtime
modules/luci-mod-network
modules/luci-mod-status
modules/luci-mod-system
protocols
themes
```
Simply run either:
```
	./build/mkbasepot.sh
```
or the following which invokes the above command
```
	./build/i18n-sync.sh -b
```

### Packages sharing strings and i18n files

When multiple packages share translation files, build a common i18n structure:

	./build/i18n-scan.pl applications/[package-1] applications/[package-2] applications/[package-n] > [location of shared template]/[application].pot


This is what the `mkbasepot.sh` script does for the `luci-base` module:

	./build/i18n-scan.pl \
		modules/luci-base modules/luci-compat modules/luci-lua-runtime \
		modules/luci-mod-network modules/luci-mod-status modules/luci-mod-system \
		protocols themes > modules/luci-base/po/templates/base.pot


## poedit - Translation tools

poedit works fine with or without "line numbers".

Should you need "line numbers" to show the source of the string and they are not present, simply run:
```
build/i18n-sync.sh --ln=full applications/luci-app-example/
```

Line numbers (a comment defining source of the string) may or may not be present.
`build/i18n-sync.sh` and other scripts may default to `--ln=never`.


### LMO files
The `*.po` files are big so Luci needs them in a compact compiled [LMO format](./LMO.md).
Luci reads `*.lmo` translations from the `/usr/lib/lua/luci/i18n/` folder.
E.g. `luci-app-acl` has an Arabic translation in `luci-i18n-acl-ar` package that installs `/usr/lib/lua/luci/i18n/acl.ar.lmo` file.

In order to quickly convert a single `.po` file to `.lmo` file for testing on the target system use the `po2lmo` utility.
You will need to compile it from the `luci-base` module:

```
	$ cd modules/luci-base/src/
	$ make po2lmo
	$ ./po2lmo
	Usage: ./po2lmo input.po output.lmo
```

Now you can compile and upload the translation:

```
	./po2lmo ../../../applications/luci-app-acl/po/ar/acl.po ./acl.ar.lmo
	scp ./acl.ar.lmo root@192.168.1.1:/usr/lib/lua/luci/i18n/
```

You can change languages in [System /Language and Style](http://192.168.1.1/cgi-bin/luci/admin/system/system) and check the translation.
